## Plasma交易快速确认方案

目前 Plasma MVP 方案要求新交易的输入在一个已确认的区块中，而区块需要在以太坊主网进行确认，这意味着用户必须等待交易被提交至以太坊主网后才能再次将该交易作为输入产生新交易，以太坊主网平均16秒产生一个区块，这也意味着在 Plasma 子链中单个资产的流转速度也无法超过每次16秒。本文将基于 David Knott, Kelvin Fichter 的 [“Plasma w/o Confirmations”](https://github.com/omisego/research/blob/master/plasma/plasma-mvp/specifications/no-confirmations.md) 方案以及 Ben Jones, Kelvin Fichter 的 [“More Viable Plasma”](https://ethresear.ch/t/more-viable-plasma/2160) 方案，提出一个新的解决方案，以使新交易可将未确认的区块中的交易作为输入，从而大大增加资产流转速度。



### 交易接收签名

节点在接收并验证交易后返回该交易即将打包的区块号、交易号以及节点签名 `sign(rlp(blockNumber，txIndex, txMerkleRoot))`。因此用户可以在区块发布至以太坊主网之前得到将要发布的区块中所有交易及其顺序。

由于需要节点在接收到交易后立刻返回相关交易信息及签名，因此推荐使用单节点或能高效达成共识的共识机制。

 

### 挑战区块

当用户收到节点返回的交易信息及其签名后，他可以在某种程度上信任该信息并基于该交易产生新的交易。如果节点没有将该区块正确的发布至主网合约时，用户可以通过以下两种方法挑战区块。

方法一：

用户直接提交 txMerkleRoot 不在 blockNumber 的 txIndex 位置的证明。此时将直接挑战成功，该区块将被视为无效。

方法二：

1. 用户提交 `rlp(blockNumber，txIndex, txMerkleRoot)` 以及 `sign` 并附上一定数量 Eth 作为抵押，挑战 blockNumber 区块。
2. 在一定期限内，节点做出回应，回应需要提交  `rlp(blockNumber，txIndex, txMerkleRoot)`  存在于该检查点的证明，如果没有回应，则该区块视为无效。

当用户拥有挑战区块的区块信息时，可以使用方法一，直接将该区块无效化。当用户没有挑战区块的区块信息时，依然可以通过方法二进行挑战。

由于区块具有被无效化的风险，因此请将本方案使用在能够承担此风险的场景中。



### 无效化区块攻击

由于可以通过提交交易接收签名的方式使区块无效化，节点可能自行提交交易接收签名以使某个区块无效。为了减少这种攻击的可能性，我们需要增加以下规则：

1. 两个区块之间需要间隔 `N` 个 ETH 区块
2. 只能挑战在最近的 `M` 个 ETH 区块中的区块
3. 挑战成功后除了挑战者获得节点抵押的一定数量的代币以外，节点还必须销毁一部分代币

规则1、规则2 保证了用户拥有足够的时间对区块进行挑战，同时也保证了较早的区块不会被无效化。

规则3 保证了即使发生节点通过自己挑战区块使区块无效化，它依旧要损失一部分代币。从而防止节点自行无效化区块。



### 退出

退出方案基于 David Knott, Kelvin Fichter 的 [“Plasma w/o Confirmations”](https://github.com/omisego/research/blob/master/plasma/plasma-mvp/specifications/no-confirmations.md) 方案以及 Ben Jones, Kelvin Fichter 的 [“More Viable Plasma”](https://ethresear.ch/t/more-viable-plasma/2160) 方案，并增加一些额外的要求。规则如下：

1. 交易必须在当前区块的 `P` 个交易号之内被节点打包
2. 交易的输入的区块号小于交易的区块号或交易的输入的交易号小于等于交易的交易号减 `P`
3. 区块必须在 `M - Q` 个 ETH 区块内被发布至以太坊主网
4. 退出的交易所在的区块必须发布在 `M` 个 ETH 区块之前
5. 退出以交易最大输入区块号、交易号顺序作为第一序，交易所在区块号、交易号逆序作为第二序进行排队，退出需要等待 `7` 天
6. 退出交易时需要同时验证它所有输入
7. 交易挑战期为 `3` 天

以上规则中的时间可以做相应调整。

规则1、规则2 保证了从交易提交的交易号到最晚被打包的交易号之前的 `P` 个交易，不存在输入的交易号也在这之间的非法交易。

规则3 保证了节点不能将区块过晚的提交至以太坊主网，从而保证用户足够的时间对区块进行挑战。

规则4 保证了退出的交易所在的区块是一个有效区块，不会被无效化。

规则5、规则6 保证了合法交易比非法交易有更高的退出优先权。

规则7 保证了延后退出的交易依然比非法交易有更高的退出优先权。



### 区块拒绝服务攻击

对于 Plasma 系统，节点不公开区块信息所发起的区块拒绝服务攻击是一个很大的问题。规则的制定很大程度上也围绕着防御区块拒绝服务攻击进行的。

假设用户在交易号 `A` 时提交交易，此时他已经验证了该区块交易号 `A` 之前被接收的所有交易并得到了相应签名，也就是说，如果节点发布的区块后所包含的交易号 `A` 之前的交易信息不正确或未公开，用户都可以通过挑战区块的方式使该区块无效化。而用户提交的交易也不会在交易号 `A + P` 之后被包含进去。因此他可以通过以下方式退出：

1. **用户** 尝试退出该交易的输入
2. `4` 天内 **节点** 通过该交易发起挑战，从而公开了该交易信息
3. **用户** 通过该交易退出，因为该交易比节点伪造的非法事务有更高的退出优先权，而且此时仍在 `7` 天内，**节点** 尚未成功退出非法事务，所以 **用户** 可以成功退出，此时若所有用户都按规则退出，**节点** 提交的非法事务退出时合约已被清空，它将无法获得它的非法所得



### 改造要求

在使用本方案对节点达成共识的时间有较高的要求，并且要求节点能实时达成关于交易排序的共识，因此使用单节点或者 POA 等能高效达成共识的共识机制较为适合。

由于区块可能被无效化，即使方案使这种情况发生的概率较低，依旧需要考虑使用场景是否能承担此风险。