## FastX Calcite 技术方案

本文主要介绍 FastX 的第一个迭代版本 Calcite。FastX 是一个基于 Plasma 的交易协议，Calcite 版本将基于 [Low Latency Transaction on Plasma](https://github.com/FastXProtocol/fastx-doc/blob/master/Low%20Latency%20Transaction%20on%20Plasma/Low%20Latency%20Transaction%20on%20Plasma.md) 方案实现。本文假定读者具有以太坊相关知识，并熟悉 [Plasma](http://plasma.io/) 的主体思想。



### 简介

通过将子链交易打包发布至主网合约，FastX 使用户可以在不牺牲安全性的前提下大量提升交易速度并降低交易费用。

#### 主要特点

以下为 FastX 的几个主要特点：

1. 支持 ETH，ERC20 以及 ERC721
2. 支持原子交易
3. 交易快速确认
4. 子链节点需要单节点或少量使用快速共识机制（如 POA）节点
5. 可以通过在主网交易退出凭证进行快速退出，但这会需要一定成本
6. 这是一个单层的 Plasma 结构，并不支持在子链上创建新的链

用户将资产通过主网合约存入 FastX 子链后，可以在子链上进行高速的交易并可以在任何情况下（包括子链节点不工作或试图攻击网络）调用主网合约将资产退出子链。此方案仅可能在以太坊主网发生长时间拥堵的情况下失效。

整个网络分为以下几个组件：

1. 主网合约：负责提供安全性

   - 接收并保管用户资产
   - 保存子链区块的哈希值
   - 安全地完成用户的资产退出操作
2. 子链节点：负责提供可扩展性
   - 验证交易并及时返回交易确认签名
   - 将子链区块哈希值提交至主网合约
   - 及时广播子链区块信息及已确认交易信息
3. 观察者：检测子链工作状态，确保子链工作正常。这个部分是可选的
   - 监控主网合约及子网运行状态，发现异常及时发起挑战并提醒用户
   - 帮助用户完成退出流程



### 主网合约

主网合约通过以太坊网络的安全性赋予用户资产的安全性，用户可以随时通过主网合约退出子链。

#### 存入

用户可以通过调用主网合约存入 ETH、ERC20 及 ERC721 资产。一旦存入主网合约，子链上会产生对应的 UTXO，用户可以使用这个 UTXO 在子链中快速交易。而用户的资产始终托管在主网合约中，因此无论子链处于什么状态，用户都可以随时从主网合约退出他的资产。

#### 提交区块

只有属于子链节点的事先被认证的指定地址才能提交区块，每个区块保存了相应子链区块的哈希值，从而达到了压缩子链信息的作用。

#### 挑战区块

根据  [Low Latency Transaction on Plasma](https://github.com/FastXProtocol/fastx-doc/blob/master/Low%20Latency%20Transaction%20on%20Plasma/Low%20Latency%20Transaction%20on%20Plasma.md) 方案，节点需要在验证用户交易后快速返回确认签名 `sign(rlp(blockNumber，txIndex, txMerkleRoot))`，而当节点不遵从该签名所代表的承诺，没有把相应交易发布至主网合约时，用户可以通过以下两种方法挑战区块。

方法一：

用户直接提交 txMerkleRoot 不在 blockNumber 的 txIndex 位置的证明。此时将直接挑战成功，该区块将被视为无效。

方法二：

1. 用户提交 `rlp(blockNumber，txIndex, txMerkleRoot)` 以及 `sign` 并附上一定数量 Eth 作为抵押，挑战 blockNumber 区块。
2. 在一定期限内，节点做出回应，回应需要提交  `rlp(blockNumber，txIndex, txMerkleRoot)`  存在于该检查点的证明，如果没有回应，则该区块视为无效。

当用户拥有挑战区块的区块信息时，可以使用方法一，直接将该区块无效化。当用户没有挑战区块的区块信息时，依然可以通过方法二进行挑战。

因此，当节点试图做恶时，本方案可能会发生交易回退，而为了尽可能减小发生这种问题时的影响，我们增加了以下规则：

1. 两个区块之间需要间隔 `N` 个 ETH 区块
2. 只能挑战在最近的 `M` 个 ETH 区块中的区块
3. 挑战成功后除了挑战者获得节点抵押的一定数量的代币以外，节点还必须销毁一部分代币

规则1、规则2 保证了用户拥有足够的时间对区块进行挑战，同时也保证了较早的区块不会被无效化。

规则3 保证了如果节点试图通过挑战自己的区块使区块无效化，它依旧要损失一部分代币。从而防止节点自行无效化区块。

#### 退出及挑战

退出部分可以说是主链合约中最重要的部分，它保证了用户的资产安全，也就是说需要保证以下几点：

1. 只有被证明属于被包含在子链中的 UTXO 可以退出，
2. 尝试退出双花交易将被取消并惩罚
3. 退出队列是有序的，更早的 UTXO 将有更高的优先级，从而保证即使在子链受到节点攻击的情况下合法的 UTXO 依然可以优先退出

所有的资产都是以 UTXO 形式存在于子链中。同一个区块的交易都会以默克尔树的形式组织起来，默克尔树的根哈希会被提交至主链合约中。用户在退出时需要提供退出的 UTXO 存在于某个默克尔树的根哈希中的证明，并且需要等待一定挑战时间。在挑战时间内，任意其他用户包括节点都可以通过提交该 UXTO 被双花的证明从而阻止这次退出并给予该用户一定的惩罚。通过这种退出及挑战机制，上文提到的第 1 点和第 2 点可以被保证，第 3 点情况主要涉及到节点做恶的情况，为了保证第 3 点，我们进一步引入以下退出规则：

1. 交易必须在当前区块的 `P` 个交易号之内被节点打包

2. 交易的输入的区块号小于交易的区块号或交易的输入的交易号小于等于交易的交易号减 `P`

3. 区块必须在 `M - Q` 个 ETH 区块内被发布至以太坊主网。其中 `M` 为上文提到的能挑战的最近的 `M` 个 ETH 区块中的区块，`Q` 为比 `M` 小的正整数，一般为 `M` 的一半

4. 退出的交易所在的区块必须发布在 `M` 个 ETH 区块之前

5. 交易挑战期为 `S` 天

6. 退出以交易最大输入区块号、交易号顺序作为第一序，交易所在区块号、交易号逆序作为第二序进行排队。即退出队列满足条件形如一下形式：

   ```sql
   Order by MAX(inputBlockNum1 * 100000 + inputTxIdx1, inputBlockNum2 * 100000 + inputTxIdx2) ASC, (blockNum * 100000 + txIdx) DESC
   ```

   其中 `inputBlockNum` 表示输入所在的区块号，`inputTxIdx` 表示输入所在的交易号，`blockNum` 表示该交易的区块号， `txIdx` 表示该交易的交易号

8. 退出需要等待 `T` 天。其中 `T` 大于 `S * 2` ，一般略大于 `S * 2` 

9. 退出交易时需要同时验证它所有输入

规则1、规则2 保证了从交易提交的交易号到最晚被打包的交易号之前的 `P` 个交易，不存在输入的交易号也在这之间的非法交易。

规则3 保证了节点不能将区块过晚的提交至以太坊主网，从而保证用户足够的时间对区块进行挑战。

规则4 保证了退出的交易所在的区块是一个有效区块，不会被无效化。

规则5、规则6、规则7、规则8 保证了合法交易比非法交易有更高的退出优先权，并且在非法交易被提交后依然有充足的时间提交合法交易。

#### 区块拒绝服务攻击

对于 Plasma 系统，节点不公开区块信息所发起的区块拒绝服务攻击是一个很大的问题。规则的制定很大程度上也围绕着防御区块拒绝服务攻击进行的。

假设用户在交易号 `A` 时提交交易，此时他已经验证了该区块交易号 `A` 之前被接收的所有交易并得到了相应签名，也就是说，如果节点发布的区块后所包含的交易号 `A` 之前的交易信息不正确或未公开，用户都可以通过挑战区块的方式使该区块无效化。而用户提交的交易也不会在交易号 `A + P` 之后被包含进去。因此他可以通过以下方式退出：

1. 用户尝试退出该交易的输入
2. `S` 天内节点通过该交易发起挑战，从而公开了该交易信息
3. 用户通过该交易退出，因为该交易比节点伪造的非法事务有更高的退出优先权，而且此时仍在 `T` 天内，节点尚未成功退出非法事务，所以用户可以成功退出，此时若所有用户都按规则退出，节点提交的非法事务退出时合约已被清空，它将无法获得它的非法所得



### 子链

#### 发布交易信息

子链节点需要及时发布已提交主网的区块的交易信息以及当前区块的交易信息及其节点签名。已提交主网的区块信息可以通过默克尔树根哈希的运算与主网合约中已提交的默克尔树根哈希进行验证。当前区块的交易信息可以通过与其对应的节点签名进行验证并在当前区块默克尔树根哈希提交至主网合约后再次进行验证。

根据  [Low Latency Transaction on Plasma](https://github.com/FastXProtocol/fastx-doc/blob/master/Low%20Latency%20Transaction%20on%20Plasma/Low%20Latency%20Transaction%20on%20Plasma.md) 方案的要求，子链节点需要在确认交易后迅速发布其相关信息及节点签名，以使整个网络可以高效运转。

#### 确认交易

子链节点在接收到交易信息后，需要对其进行验证。如果交易合法，子链需要确定交易在当前区块中的交易号并进行签名 `sign(rlp(blockNumber，txIndex, txMerkleRoot))`。此时节点相当于做出了一个未来一定会将此交易包含在签名所指定的区块号、交易号上的承诺。

#### 发布区块

每隔大约  `M - Q` 个 ETH 区块（可能会略长，这取决于第一个被确认的交易）子链节点需要向主网合约提交区块，同时向全网广播该区块所有信息。

如果用户在一定时间内无法获取该区块的信息，那么很有可能是子链节点发动了区块拒绝服务攻击，此时所有用户都应将他的资产退出子链。

#### 交易

交易接受可用的 UTXO 作为输入，创建新的 UTXO 作为输出。输出的 UTXO 总资产必须小于等于（通常情况是等于）输入的 UTXO 总资产。输入的 UTXO 的拥有者必须都对该交易进行签名。

每个交易拥有 4 个输入，4 个输出。交易费使用显式的方式，需要占用一个输出位置进行交易费的缴纳。

交易的定义如下：

```javascript
[inPos1, inPos2, inPos3, inPos4,
 sig1, sig2, sig3, sig4,
 newOwner1, contractAddress1, amount1, tokenid1,
 newOwner2, contractAddress2, amount2, tokenid2,
 newOwner3, contractAddress3, amount3, tokenid3,
 newOwner4, contractAddress4, amount4, tokenid4]
```

- `inPos` 输入 UTXO 位置，等于 `blockNum * 1000000000 + txIdx * 10000 + oIdx` ，其中 `blockNum` 表示该 UTXO 的区块号， `txIdx` 表示该 UTXO 的交易号，`oIdx` 表示该 UTXO 的输出号。输入可以为空。
- `sig` 为签名，需要对该签名所代表的输入及输出相应字段以及所有其他输出的除 `newOwner` 字段以外的字段进行签名。如，`sig1` 为 `sign(rlp(inPos1, newOwner1, contractAddress1, amount1, tokenid1, contractAddress2, amount2, tokenid2, contractAddress3, amount3, tokenid3, contractAddress4, amount4, tokenid4))`。4 个签名可以完全确定整个交易，因此即使有输入为空，依然需要签名。
- `newOwner` 为新所有者的地址。
- `contractAddress` 为该资产的合约地址，目前支持 ERC20、ERC721 和 ETH，如果是 ETH 则为0。
- `amount` 为该资产的数量，如果是 ERC721，则为0。
- `tokenid` 为该资产的编号，如果不是 ERC721，则为0。

在实际操作中，`amount` 和 `tokenid` 可以压缩为同一个字段表示。

#### 部分签名交易

只完成了 1 到 3 个签名的交易被称为部分签名交易。用户可以在任意信息交换平台上发布部分签名交易。部分签名交易实际上等同于卖单或买单，其他用户可以接受某个部分签名交易并将其填写完整后发布至子链从而完成交易。并且整个交易过程是原子的。

为了满足交易需求，实际上我们需要一个部分签名交易池（这不是必须的）。用户设置好他需求的买卖价格、买卖种类、以及该需求的过期时间后就可以将它进行部分签名并存放至部分签名交易池中，其他用户就可以接受并完成他的交易请求。整个系统中可以有任意数量的部分签名交易池，部分签名交易池为整个系统提供了交易深度。

由于子链节点收取交易手续费，更多的交易有利于提高他的收入，因此子链节点也有动力维护他自己的部分签名交易池。当然，这不是必须的。



### 观察者

观察者节点可以由任何用户运行，实际上用户所使用的客户端也是某种形式的观察者节点。一般情况下，以小于 `S` 天的间隔时间进行观察就可以确保用户的资产安全。当然用户也可以委托他所信任的观察者节点（服务提供商）帮助进行观察。

专门的观察者节点并不是必须的，观察者节点的主要工作是对整个网络（主要是子链节点）进行监控，从而防止有用户或节点做恶，并从挑战中获取回报。我们注意到在一个健康的网络中做恶的行为是很少的，在这种情况下，观察者节点依然可以通过帮助用户完成退出流程，从中获取用户提交的一部分退出手续费。用户在发出将他的资产提回 ETH 主网的请求之后需要等待一段时间以允许其他人进行挑战，在挑战期结束之后再次请求才能完成整个流程，此时观察者节点就能帮助用户完成流程而不需要用户再发起额外的请求。